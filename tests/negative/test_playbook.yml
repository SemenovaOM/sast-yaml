---
- name: Configure web server
  hosts: webservers
  become: yes
  vars:
    app_version: "1.0.0"
    nginx_version: "1.18.*"
    
  tasks:
    - name: Install nginx web server
      apt:
        name: "nginx={{ nginx_version }}"
        state: present

    - name: Ensure nginx is running and enabled
      systemd:
        name: nginx
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Set directory permissions
      file:
        path: /var/www
        owner: www-data
        group: www-data
        recurse: yes
        state: directory

    - name: Deploy application configuration
      copy:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/sites-available/app
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: Enable site
      file:
        src: /etc/nginx/sites-available/app
        dest: /etc/nginx/sites-enabled/app
        state: link

    - name: Install additional packages
      apt:
        name:
          - curl=7.68.*
          - wget=1.20.*
        state: present

    - name: Validate nginx configuration
      command: nginx -t
      changed_when: false
      register: nginx_validation
      failed_when: nginx_validation.rc != 0

    - name: Reload nginx if configuration changed
      systemd:
        name: nginx
        state: reloaded
      when: nginx_validation.rc == 0

    - name: Check service status
      systemd:
        name: nginx
        state: started
      changed_when: false